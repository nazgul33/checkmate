<html>
<head>
    <meta charset="utf-8" />
    <title>Impala</title>
    <style type="text/css">
    @import '/static/css/iphc.css';
    </style>
    <script src="/static/js/iphc.js"></script>
</head>

<script type="text/javascript">
var g_running_queries = [];
var g_impalad_servers = [];
var g_clusters = [];
var g_current_cluster = '';

function loadServers() {
    $.getJSON('/api/v1/impala/impalad_status?cluster='+g_current_cluster, function(result) {
        if (result.status == 'ok') {
            var table = '<table class="table table-striped" width="80%">\n<tr><th>Server</th><th>Last Active</th><th>Active Since</th></tr>\n';
            g_impalad_servers = result.value;
            for (server in result.value) {
                var last_update = new Date(result.value[server].updated);
                var first_seen = new Date(result.value[server].first_seen);
                table += '<tr><td>' + server + '</td><td>' + formatDate(last_update) + '</td><td>' + formatDate(first_seen) + '</td></tr>\n';
            }
            table += '</table>';
            $('#impala_servers').html(table);
        }
    });
}

function loadQueries() {
    $.getJSON('/api/v1/impala/running_queries?cluster='+g_current_cluster, function(result) {
        if (result.status == 'ok') {
            var tNow = new Date();
            var table = '<table class="table table-striped" width="80%">\n<tr><th>server</th><th>User</th><th>Statement</th><th>Backend Progress</th><th>Start Time</th><th>Time spent</th></tr>\n';
            g_running_queries = result.value;
            for (var q_id in result.value) {
                var q = result.value[q_id];
                var st = new Date(q.start_time);
                var timespent_ms = tNow - st;
                var tr_class = (q.stall == true)? ' class="stall"':'';
                table += '<tr' + tr_class + '><td>' + q.server + '</td><td>' + q.user + '</td><td>' + q.statement + '</td><td>' + q.backend_progress + '</td><td>' + formatDate(st) + '</td><td>' + timespent_ms + '</td></tr>\n';
            }
            table += '</table>';
            $('#impala_queries').html(table);
        }
    });
}

function loadClusters() {
    $.getJSON('/api/v1/impala/clusters', function(result) {
        if (result.status == 'ok') {
            var links = '';
            g_clusters = result.value;
            for (var i=0; i<g_clusters.length; i++) {
                var c = g_clusters[i];
                links += '<button onclick="startRefreshTimer(\'' + c + '\')">' + c +'</button>&nbsp;';
            }
            $('#clusters').html(links);

        }
    });
}

var reload_timer = null;
function startRefreshTimer(cluster_name) {
    if (reload_timer) {
        clearInterval(reload_timer);
        reload_timer = null;
    }
    g_current_cluster = cluster_name;
    setTimeout(loadQueries(), 0);
    reload_timer = setInterval(loadQueries(), 5000);
}

$(function() {
    loadClusters();
});

</script>

<body>
    <H1>clusters</H1>
    <div id="clusters"></div>

    <H1>queries</H1>
    <div id="impala_queries" align="center">
    </div>

    <H1>servers</H1>
    <div id="impala_servers" align="center">
    </div>
</body>

</html>
